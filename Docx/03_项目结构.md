# MessageIn - 项目结构

## 项目目录结构

```
messagein/
│
├── client/                        # 前端代码
│   ├── teacher/                   # 教师客户端
│   │   ├── src/                   # 源代码
│   │   │   ├── assets/            # 静态资源
│   │   │   ├── components/        # Vue组件
│   │   │   │   ├── Dashboard/     # 仪表盘组件
│   │   │   │   ├── Messages/      # 消息相关组件
│   │   │   │   └── Classes/       # 班级相关组件
│   │   │   ├── services/          # API服务
│   │   │   ├── store/             # Vuex/Pinia状态管理
│   │   │   ├── router/            # Vue Router路由配置
│   │   │   ├── views/             # 页面视图组件
│   │   │   ├── App.vue            # 主应用组件
│   │   │   └── main.js            # 入口文件
│   │   ├── public/                # 公共资源
│   │   ├── electron/              # Electron配置
│   │   ├── package.json           # 依赖配置
│   │   └── vue.config.js          # Vue配置
│   │
│   ├── admin/                     # 管理员客户端
│   │   ├── src/                   # 源代码
│   │   │   ├── assets/            # 静态资源
│   │   │   ├── components/        # Vue组件
│   │   │   │   ├── Dashboard/     # 仪表盘组件
│   │   │   │   ├── Users/         # 用户管理组件
│   │   │   │   └── Settings/      # 系统设置组件
│   │   │   ├── services/          # API服务
│   │   │   ├── store/             # Vuex/Pinia状态管理
│   │   │   ├── router/            # Vue Router路由配置
│   │   │   ├── views/             # 页面视图组件
│   │   │   ├── App.vue            # 主应用组件
│   │   │   └── main.js            # 入口文件
│   │   ├── public/                # 公共资源
│   │   ├── electron/              # Electron配置
│   │   ├── package.json           # 依赖配置
│   │   └── vue.config.js          # Vue配置
│   │
│   └── display/                   # 大屏显示客户端
│       ├── src/                   # 源代码
│       │   ├── assets/            # 静态资源
│       │   ├── components/        # Vue组件
│       │   │   ├── Danmaku/       # 弹幕组件
│       │   │   └── History/       # 历史消息组件
│       │   ├── services/          # API服务
│       │   ├── store/             # Vuex/Pinia状态管理
│       │   ├── views/             # 页面视图组件
│       │   ├── App.vue            # 主应用组件
│       │   └── main.js            # 入口文件
│       ├── public/                # 公共资源
│       ├── electron/              # Electron配置
│       ├── package.json           # 依赖配置
│       └── vue.config.js          # Vue配置
│
├── server/                        # 后端代码
│   ├── src/                       # 源代码
│   │   ├── api/                   # API路由
│   │   │   ├── routes/            # 路由定义
│   │   │   │   ├── auth.js        # 认证路由
│   │   │   │   ├── users.js       # 用户路由
│   │   │   │   ├── classes.js     # 班级路由
│   │   │   │   └── messages.js    # 消息路由
│   │   │   └── index.js           # API路由入口
│   │   ├── config/                # 配置文件
│   │   │   ├── database.js        # 数据库配置
│   │   │   ├── auth.js            # 认证配置
│   │   │   └── websocket.js       # WebSocket配置
│   │   ├── controllers/           # 控制器
│   │   │   ├── authController.js  # 认证控制器
│   │   │   ├── userController.js  # 用户控制器
│   │   │   ├── classController.js # 班级控制器
│   │   │   └── messageController.js # 消息控制器
│   │   ├── middleware/            # 中间件
│   │   │   ├── auth.js            # 认证中间件
│   │   │   ├── validation.js      # 验证中间件
│   │   │   └── errorHandler.js    # 错误处理中间件
│   │   ├── models/                # 数据模型
│   │   │   ├── User.js            # 用户模型
│   │   │   ├── Class.js           # 班级模型
│   │   │   ├── Message.js         # 消息模型
│   │   │   ├── ReadRecord.js      # 阅读记录模型
│   │   │   └── SystemLog.js       # 系统日志模型
│   │   ├── services/              # 服务
│   │   │   ├── authService.js     # 认证服务
│   │   │   ├── userService.js     # 用户服务
│   │   │   ├── classService.js    # 班级服务
│   │   │   └── messageService.js  # 消息服务
│   │   ├── utils/                 # 工具函数
│   │   │   ├── logger.js          # 日志工具
│   │   │   ├── validator.js       # 验证工具
│   │   │   └── helpers.js         # 辅助函数
│   │   ├── websocket/             # WebSocket处理
│   │   │   ├── handlers/          # 消息处理器
│   │   │   └── index.js           # WebSocket服务入口
│   │   └── app.js                 # 应用入口
│   ├── .env                       # 环境变量
│   ├── .env.example               # 环境变量示例
│   ├── package.json               # 依赖配置
│   └── nodemon.json               # Nodemon配置
│
├── shared/                        # 共享代码
│   ├── constants/                 # 常量定义
│   ├── validation/                # 验证规则
│   └── types/                     # 类型定义
│
├── scripts/                       # 脚本文件
│   ├── setup.js                   # 安装脚本
│   ├── build.js                   # 构建脚本
│   └── deploy.js                  # 部署脚本
│
├── docs/                          # 文档
│   ├── api/                       # API文档
│   ├── setup/                     # 安装文档
│   └── user/                      # 用户文档
│
├── .gitignore                     # Git忽略文件
├── README.md                      # 项目说明
├── package.json                   # 根依赖配置
└── docker-compose.yml             # Docker配置
```

## 核心文件说明

### 前端核心文件

#### 老师端 (Vue.js)

- **src/components/Messages/MessageComposer.vue**: 消息编写组件
  ```vue
  <template>
    <div class="message-composer">
      <el-form :model="messageForm" :rules="rules" ref="messageForm">
        <el-form-item label="接收班级" prop="classId">
          <el-select v-model="messageForm.classId" placeholder="选择班级">
            <el-option
              v-for="item in classes"
              :key="item.id"
              :label="item.name"
              :value="item.id">
            </el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="消息优先级" prop="priority">
          <el-radio-group v-model="messageForm.priority">
            <el-radio label="normal">普通</el-radio>
            <el-radio label="important">重要</el-radio>
            <el-radio label="urgent">紧急</el-radio>
          </el-radio-group>
        </el-form-item>
        <el-form-item label="显示时间(分钟)" prop="displayDuration">
          <el-input-number v-model="messageForm.displayDuration" :min="5" :max="1440"></el-input-number>
        </el-form-item>
        <el-form-item label="消息内容" prop="content">
          <el-input type="textarea" v-model="messageForm.content" rows="4"></el-input>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="submitForm">发送消息</el-button>
          <el-button @click="resetForm">重置</el-button>
        </el-form-item>
      </el-form>
    </div>
  </template>

  <script>
  import { reactive, ref, onMounted } from 'vue'
  import { useStore } from 'vuex'
  import { ElMessage } from 'element-plus'
  import { getClasses, createMessage } from '@/services/api'

  export default {
    name: 'MessageComposer',
    setup() {
      const store = useStore()
      const messageForm = reactive({
        classId: '',
        priority: 'normal',
        displayDuration: 60,
        content: ''
      })
      const classes = ref([])
      const messageFormRef = ref(null)

      const rules = {
        classId: [{ required: true, message: '请选择接收班级', trigger: 'change' }],
        content: [{ required: true, message: '请输入消息内容', trigger: 'blur' }]
      }

      onMounted(async () => {
        try {
          const response = await getClasses()
          classes.value = response.data
        } catch (error) {
          ElMessage.error('获取班级列表失败')
          console.error(error)
        }
      })

      const submitForm = async () => {
        if (!messageFormRef.value) return
        
        await messageFormRef.value.validate(async (valid) => {
          if (valid) {
            try {
              await createMessage(messageForm)
              ElMessage.success('消息发送成功')
              resetForm()
            } catch (error) {
              ElMessage.error('消息发送失败')
              console.error(error)
            }
          }
        })
      }

      const resetForm = () => {
        if (messageFormRef.value) {
          messageFormRef.value.resetFields()
        }
      }

      return {
        messageForm,
        classes,
        messageFormRef,
        rules,
        submitForm,
        resetForm
      }
    }
  }
  </script>
  ```

- **src/components/Messages/MessageList.vue**: 消息列表组件
- **src/components/Messages/MessageStats.vue**: 消息统计组件
- **src/services/messageService.js**: 消息API服务
- **src/services/socketService.js**: WebSocket连接服务

#### 学生大屏端 (Vue.js)

- **src/components/Danmaku/DanmakuContainer.vue**: 弹幕容器组件
  ```vue
  <template>
    <div class="danmaku-container">
      <transition-group name="danmaku" tag="div">
        <danmaku-item
          v-for="message in activeMessages"
          :key="message.id"
          :message="message"
          @mark-read="markAsRead"
        />
      </transition-group>
    </div>
  </template>

  <script>
  import { ref, onMounted, onUnmounted } from 'vue'
  import { useStore } from 'vuex'
  import DanmakuItem from './DanmakuItem.vue'
  import { getUnreadMessages, markMessageAsRead } from '@/services/api'
  import { initSocket } from '@/services/socketService'

  export default {
    name: 'DanmakuContainer',
    components: {
      DanmakuItem
    },
    props: {
      classId: {
        type: String,
        required: true
      }
    },
    setup(props) {
      const store = useStore()
      const activeMessages = ref([])
      let socket = null

      const fetchUnreadMessages = async () => {
        try {
          const response = await getUnreadMessages(props.classId)
          activeMessages.value = response.data
        } catch (error) {
          console.error('获取未读消息失败', error)
        }
      }

      const markAsRead = async (messageId) => {
        try {
          await markMessageAsRead(messageId, props.classId)
          activeMessages.value = activeMessages.value.map(msg => {
            if (msg.id === messageId) {
              return { ...msg, isRead: true }
            }
            return msg
          })
        } catch (error) {
          console.error('标记消息已读失败', error)
        }
      }

      onMounted(() => {
        fetchUnreadMessages()
        
        // 初始化WebSocket连接
        socket = initSocket(props.classId)
        
        // 监听新消息事件
        socket.on('new_message', (message) => {
          activeMessages.value.push({
            ...message,
            isRead: false
          })
        })
        
        // 监听消息过期事件
        socket.on('message_expired', ({ messageId }) => {
          activeMessages.value = activeMessages.value.filter(
            msg => msg.id !== messageId
          )
        })
      })

      onUnmounted(() => {
        if (socket) {
          socket.disconnect()
        }
      })

      return {
        activeMessages,
        markAsRead
      }
    }
  }
  </script>

  <style scoped>
  .danmaku-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    pointer-events: none;
  }

  .danmaku-enter-active,
  .danmaku-leave-active {
    transition: all 0.5s ease;
  }

  .danmaku-enter-from {
    transform: translateX(100%);
    opacity: 0;
  }

  .danmaku-leave-to {
    transform: translateX(-100%);
    opacity: 0;
  }
  </style>
  ```

- **src/components/Danmaku/DanmakuItem.vue**: 单条弹幕组件
- **src/services/messageService.js**: 消息API服务
- **src/services/socketService.js**: WebSocket连接服务

### 后端核心文件

- **src/controllers/messageController.js**: 消息控制器
  ```javascript
  // 创建新消息
  exports.createMessage = async (req, res) => {
    try {
      const { content, classId, priority, displayDuration } = req.body;
      const senderId = req.user.id;
      
      // 创建消息
      const message = await Message.create({
        content,
        senderId,
        classId,
        priority,
        status: 'active',
        displayDuration,
        readCount: 0,
        createdAt: new Date(),
        expiresAt: new Date(Date.now() + displayDuration * 60000)
      });
      
      // 通过WebSocket推送消息到对应班级
      io.to(`class-${classId}`).emit('new_message', message);
      
      res.status(201).json({ success: true, data: message });
    } catch (error) {
      res.status(500).json({ success: false, error: error.message });
    }
  };
  
  // 确认消息已读
  exports.markAsRead = async (req, res) => {
    try {
      const { messageId, classId } = req.body;
      
      // 创建已读记录
      await ReadRecord.create({
        messageId,
        classId,
        readAt: new Date(),
        createdAt: new Date()
      });
      
      // 更新消息已读计数
      const message = await Message.findByIdAndUpdate(
        messageId,
        { $inc: { readCount: 1 } },
        { new: true }
      );
      
      // 通过WebSocket推送已读状态更新
      io.to(`teacher-${message.senderId}`).emit('message_read', {
        messageId,
        readCount: message.readCount
      });
      
      res.status(200).json({ success: true });
    } catch (error) {
      res.status(500).json({ success: false, error: error.message });
    }
  };
  ```

- **src/websocket/index.js**: WebSocket服务
  ```javascript
  const socketIo = require('socket.io');
  const jwt = require('jsonwebtoken');
  const config = require('../config/auth');
  
  module.exports = (server) => {
    const io = socketIo(server);
    
    // 中间件：验证连接的用户身份
    io.use((socket, next) => {
      if (socket.handshake.query && socket.handshake.query.token) {
        jwt.verify(socket.handshake.query.token, config.secret, (err, decoded) => {
          if (err) return next(new Error('认证失败'));
          socket.user = decoded;
          next();
        });
      } else {
        next(new Error('认证失败'));
      }
    });
    
    io.on('connection', (socket) => {
      console.log(`用户连接: ${socket.user.username}`);
      
      // 根据用户角色加入不同的房间
      if (socket.user.role === 'teacher') {
        socket.join(`teacher-${socket.user.id}`);
      } else if (socket.user.role === 'display') {
        // 大屏显示端加入班级房间
        socket.join(`class-${socket.handshake.query.classId}`);
      }
      
      socket.on('disconnect', () => {
        console.log(`用户断开连接: ${socket.user.username}`);
      });
    });
    
    return io;
  };
  ```

## 数据模型示例

### 用户模型 (User.js)

```javascript
const mongoose = require('mongoose');
const bcrypt = require('bcryptjs');

const UserSchema = new mongoose.Schema({
  username: {
    type: String,
    required: true,
    unique: true
  },
  password: {
    type: String,
    required: true
  },
  name: {
    type: String,
    required: true
  },
  role: {
    type: String,
    enum: ['admin', 'teacher', 'display'],
    required: true
  },
  email: String,
  phone: String,
  avatar: String,
  createdAt: {
    type: Date,
    default: Date.now
  },
  updatedAt: {
    type: Date,
    default: Date.now
  }
});

// 保存前对密码进行哈希处理
UserSchema.pre('save', async function(next) {
  if (!this.isModified('password')) return next();
  
  try {
    const salt = await bcrypt.genSalt(10);
    this.password = await bcrypt.hash(this.password, salt);
    next();
  } catch (error) {
    next(error);
  }
});

// 验证密码方法
UserSchema.methods.validatePassword = async function(password) {
  return await bcrypt.compare(password, this.password);
};

module.exports = mongoose.model('User', UserSchema);
```

### 消息模型 (Message.js)

```javascript
const mongoose = require('mongoose');

const MessageSchema = new mongoose.Schema({
  content: {
    type: String,
    required: true,
    trim: true
  },
  senderId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: true
  },
  classId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Class',
    required: true
  },
  priority: {
    type: String,
    enum: ['normal', 'important', 'urgent'],
    default: 'normal'
  },
  status: {
    type: String,
    enum: ['active', 'expired'],
    default: 'active'
  },
  displayDuration: {
    type: Number,
    default: 60 // 默认显示时间（分钟）
  },
  readCount: {
    type: Number,
    default: 0
  },
  createdAt: {
    type: Date,
    default: Date.now
  },
  expiresAt: {
    type: Date,
    required: true
  }
});

// 消息过期自动更新状态的索引
MessageSchema.index({ expiresAt: 1 }, { 
  expireAfterSeconds: 0,
  partialFilterExpression: { status: 'active' }
});

module.exports = mongoose.model('Message', MessageSchema);
```

## Vue.js前端依赖

老师端、管理员端和大屏端的package.json主要依赖：

```json
{
  "dependencies": {
    "axios": "^1.3.4",
    "core-js": "^3.29.0",
    "element-plus": "^2.3.1",
    "pinia": "^2.0.33",
    "socket.io-client": "^4.6.1",
    "vue": "^3.2.47",
    "vue-router": "^4.1.6"
  },
  "devDependencies": {
    "@vitejs/plugin-vue": "^4.1.0",
    "electron": "^23.1.4",
    "electron-builder": "^23.6.0",
    "sass": "^1.59.2",
    "vite": "^4.2.0"
  }
}
``` 