<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>简易弹幕系统</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background-color: #121212;
      color: #ffffff;
      font-family: 'Microsoft YaHei', sans-serif;
    }
    
    .container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    
    /* 弹幕轨道样式 */
    .danmaku-area {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 40px;
      overflow: hidden;
      z-index: 9999;
      pointer-events: none;
    }
    
    /* 弹幕样式 */
    .danmaku-item {
      position: absolute;
      white-space: nowrap;
      top: 4px;
      left: 100%;
      padding: 2px 8px;
      height: 32px;
      line-height: 32px;
      border-radius: 4px;
      background-color: rgba(0, 0, 0, 0.7);
      color: #ffffff;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      animation: danmaku-move 8s linear forwards;
      pointer-events: none;
    }
    
    /* 弹幕移动动画 */
    @keyframes danmaku-move {
      from {
        transform: translateX(0);
      }
      to {
        transform: translateX(-200%);
      }
    }
    
    /* 控制面板 */
    .control-panel {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.7);
      padding: 10px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
    }
    
    .control-panel button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      background-color: #1976d2;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .control-panel button:hover {
      background-color: #1565c0;
    }
    
    .info-area {
      margin-top: auto;
      margin-bottom: 100px;
      text-align: center;
      pointer-events: none;
    }
    
    /* 背景样式 */
    .background {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background: linear-gradient(125deg, #1a237e, #0d47a1, #1565c0, #1976d2);
      background-size: 400% 400%;
      opacity: 0.5;
      animation: gradient-animation 15s ease infinite;
    }
    
    @keyframes gradient-animation {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 弹幕区域 -->
    <div class="danmaku-area" id="danmakuArea"></div>
    
    <!-- 背景 -->
    <div class="background"></div>
    
    <!-- 信息区域 -->
    <div class="info-area">
      <h1>简易弹幕系统</h1>
      <p>正在从 http://www.cyupeng.com/message 获取消息</p>
    </div>
    
    <!-- 控制面板 -->
    <div class="control-panel">
      <button id="toggleBtn">暂停弹幕</button>
      <button id="testBtn">发送测试弹幕</button>
    </div>
  </div>
  
  <script>
    // 弹幕系统
    class DanmakuSystem {
      constructor() {
        // 配置项
        this.apiUrl = 'http://www.cyupeng.com/message';
        this.pollingDelay = 1000;
        this.pollingInterval = null;
        this.lastContentHash = null;
        this.isRunning = true;
        this.danmakuArea = document.getElementById('danmakuArea');
        
        // 按钮事件
        document.getElementById('toggleBtn').addEventListener('click', () => this.toggleRunning());
        document.getElementById('testBtn').addEventListener('click', () => this.sendTestDanmaku());
        
        // 初始化
        this.initCorsProxy();
        this.startPolling();
      }
      
      // 初始化CORS代理
      initCorsProxy() {
        this.corsProxies = [
          'https://api.codetabs.com/v1/proxy?quest=',
          'https://cors-proxy.fringe.zone/',
          'https://thingproxy.freeboard.io/fetch/'
        ];
      }
      
      // 开始轮询
      startPolling() {
        // 立即执行一次
        this.fetchMessages();
        
        // 设置定时器
        this.pollingInterval = setInterval(() => {
          this.fetchMessages();
        }, this.pollingDelay);
        
        console.log('已启动消息轮询，间隔:', this.pollingDelay, 'ms');
      }
      
      // 停止轮询
      stopPolling() {
        if (this.pollingInterval) {
          clearInterval(this.pollingInterval);
          this.pollingInterval = null;
          console.log('已停止消息轮询');
        }
      }
      
      // 切换运行状态
      toggleRunning() {
        this.isRunning = !this.isRunning;
        const toggleBtn = document.getElementById('toggleBtn');
        
        if (this.isRunning) {
          toggleBtn.textContent = '暂停弹幕';
          this.startPolling();
        } else {
          toggleBtn.textContent = '恢复弹幕';
          this.stopPolling();
        }
      }
      
      // 获取消息
      async fetchMessages() {
        try {
          // 使用CORS代理获取消息
          const response = await this.fetchWithProxy(this.apiUrl);
          
          if (!response.ok) {
            throw new Error(`API请求失败: ${response.status}`);
          }
          
          // 获取原始文本
          const rawText = await response.text();
          console.log('API原始响应:', rawText);
          
          // 从原始文本中提取内容
          const content = this.extractContentFromText(rawText);
          console.log('提取的消息内容:', content);
          
          if (content) {
            // 计算内容哈希
            const contentHash = this.getContentHash(content);
            
            // 如果内容与上次不同，则处理新消息
            if (contentHash !== this.lastContentHash) {
              console.log('发现新消息:', content);
              this.lastContentHash = contentHash;
              this.addDanmaku(content);
            }
          }
        } catch (error) {
          console.error('获取消息失败:', error);
        }
      }
      
      // 使用代理获取URL内容
      async fetchWithProxy(url) {
        // 先尝试直接请求
        try {
          console.log('尝试直接请求:', url);
          
          const directResponse = await fetch(url, {
            method: 'GET',
            mode: 'cors',
            headers: {
              'Accept': '*/*'
            }
          });
          
          if (directResponse.ok) {
            console.log('直接请求成功');
            return directResponse;
          }
        } catch (error) {
          console.warn('直接请求失败，将尝试代理:', error);
        }
        
        // 直接请求失败，尝试所有可用的代理
        let lastError;
        
        for (const proxy of this.corsProxies) {
          try {
            const proxyUrl = `${proxy}${encodeURIComponent(url)}`;
            console.log('尝试使用代理:', proxyUrl);
            
            const response = await fetch(proxyUrl, {
              method: 'GET',
              headers: {
                'Accept': '*/*'
              }
            });
            
            if (response.ok) {
              console.log('使用代理成功:', proxy);
              return response;
            } else {
              console.warn(`代理 ${proxy} 返回非200状态码:`, response.status);
            }
          } catch (error) {
            console.warn(`代理 ${proxy} 请求失败:`, error);
            lastError = error;
          }
        }
        
        console.error('所有尝试均失败');
        throw lastError || new Error('无法获取数据：所有请求方式均失败');
      }
      
      // 从文本中提取可能的消息内容
      extractContentFromText(text) {
        if (!text || typeof text !== 'string') {
          return null;
        }
        
        // 去除首尾空白
        const trimmed = text.trim();
        
        // 测试几种可能的格式
        
        // 1. 尝试作为JSON解析
        try {
          const json = JSON.parse(trimmed);
          if (json.content) {
            return json.content;
          }
          return JSON.stringify(json);
        } catch (e) {
          // 不是有效的JSON，继续尝试
        }
        
        // 2. 尝试匹配类似 {'content':'大乐子'} 这样的格式
        const contentMatch = trimmed.match(/['"]content['"]:\s*['"](.+?)['"]/);
        if (contentMatch && contentMatch[1]) {
          return contentMatch[1];
        }
        
        // 3. 如果文本很短（小于100个字符），可能整个就是消息内容
        if (trimmed.length < 100) {
          return trimmed;
        }
        
        // 4. 否则尝试找到看起来像内容的部分
        const simpleContentMatch = trimmed.match(/{(.+?)}/);
        if (simpleContentMatch && simpleContentMatch[1]) {
          return simpleContentMatch[1];
        }
        
        // 5. 检查是否包含"大乐子"
        if (trimmed.includes('大乐子')) {
          return '大乐子';
        }
        
        // 如果以上都不匹配，返回原始文本
        return trimmed;
      }
      
      // 计算内容哈希，用于去重
      getContentHash(content) {
        let hash = 0;
        if (!content) return hash;
        for (let i = 0; i < content.length; i++) {
          const char = content.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash; // 转换为32位整数
        }
        return hash;
      }
      
      // 添加弹幕
      addDanmaku(content) {
        // 创建弹幕元素
        const danmaku = document.createElement('div');
        danmaku.className = 'danmaku-item';
        danmaku.textContent = content;
        
        // 设置随机颜色和字体大小
        danmaku.style.color = this.getRandomColor();
        danmaku.style.fontSize = `${18 + Math.floor(Math.random() * 4) * 2}px`;
        
        // 添加到DOM
        this.danmakuArea.appendChild(danmaku);
        
        // 弹幕动画结束后移除元素
        danmaku.addEventListener('animationend', () => {
          danmaku.remove();
        });
      }
      
      // 发送测试弹幕
      sendTestDanmaku() {
        const testMessages = [
          '这是测试弹幕',
          '欢迎使用简易弹幕系统',
          '弹幕功能正常运行中',
          '大乐子',
          '这是一条长一点的测试弹幕消息，看看效果如何'
        ];
        
        const randomIndex = Math.floor(Math.random() * testMessages.length);
        this.addDanmaku(testMessages[randomIndex]);
      }
      
      // 生成随机颜色
      getRandomColor() {
        const colors = [
          '#ffffff', // 白色
          '#ff4757', // 红色
          '#2ed573', // 绿色
          '#1e90ff', // 蓝色
          '#f1c40f', // 黄色
          '#e84393', // 粉色
          '#00cec9'  // 青色
        ];
        
        return colors[Math.floor(Math.random() * colors.length)];
      }
    }
    
    // 初始化弹幕系统
    document.addEventListener('DOMContentLoaded', () => {
      window.danmakuSystem = new DanmakuSystem();
    });
  </script>
</body>
</html> 